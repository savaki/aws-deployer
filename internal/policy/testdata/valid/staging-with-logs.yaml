AWSTemplateFormatVersion: '2010-09-09'
Description: Staging environment with comprehensive logging - should pass policy

Resources:
  ProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: data-processor
      Runtime: java11
      Handler: com.example.DataProcessor::handleRequest
      Code:
        ZipFile: placeholder
      Role: !GetAtt ProcessorRole.Arn
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          CACHE_TABLE: !Ref CacheTable

  ProcessorUrl:
    Type: AWS::Lambda::Url
    Properties:
      TargetFunctionArn: !Ref ProcessorFunction
      AuthType: AWS_IAM

  CacheTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: dev-myapp--cache
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: cacheKey
          AttributeType: S
      KeySchema:
        - AttributeName: cacheKey
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  ProcessorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

  CacheAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: CacheTableAccess
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
            Resource: !GetAtt CacheTable.Arn
      Roles:
        - !Ref ProcessorRole

  ProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/data-processor
      RetentionInDays: 7

  ErrorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /application/errors
      RetentionInDays: 30

  MetricsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /application/metrics
      RetentionInDays: 14